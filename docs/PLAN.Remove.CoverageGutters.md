# Plan: Remove Coverage Gutters Dependency

## Goal

Remove the dependency on the **Coverage Gutters** VS Code extension (`ryanluker.vscode-coverage-gutters`) from the local development workflow. In doing so, also clean up the NuGet package references in test projects by removing the now-unnecessary `coverlet.collector` package.

## Background

Coverage Gutters is a VS Code extension that reads coverage report files from disk (lcov, Cobertura, etc.) and renders colored line highlights in the editor gutter. It is currently used in two ways:

1. As a local viewer for coverage reports generated during `dotnet test` runs.
2. Via its `coverage-gutters.previewCoverageReport` command, which is called from `tasks.json` to open the HTML report after a test run.

Neither of these roles is essential. The HTML report generated by ReportGenerator can be opened directly in a browser. The in-editor gutter highlights can be provided natively by VS Code's built-in Testing API (see PLAN.md Phase 2 — Run with Coverage) once the extension implements `TestRunProfileKind.Coverage`.

### Is it safe to remove Coverage Gutters before the Coverage profile is implemented?

**Yes**, with one prerequisite: update the `tasks.json` `test - open` step first (replace the `coverage-gutters.previewCoverageReport` command with `cmd /c start index.html` as described in Requirement 2 below). Once that change is made, Coverage Gutters has no remaining hooks anywhere in the workflow.

**Interim gap:** Between removing Coverage Gutters and implementing the Coverage profile in the extension, you lose in-editor gutter line highlights. You still get the full HTML coverage report opened in a browser via ReportGenerator. That is a cosmetic gap only — CI, TFS build, test execution, and report generation are entirely unaffected.

**Removal order:**
1. Update `tasks.json` `test - open` step (Requirement 2 below)
2. Uninstall / remove Coverage Gutters from VS Code recommendations
3. Implement `TestRunProfileKind.Coverage` in the extension at a later time (restores gutter highlights natively, no Coverage Gutters needed)

---

## NuGet Package Context

Test projects currently reference two coverage packages:

| Package | Purpose | Mechanism |
|---|---|---|
| `coverlet.collector` | VSTest data collector — activated by `--collect:"XPlat Code Coverage"` | VSTest hook |
| `coverlet.msbuild` | MSBuild wrapper — activated by `/p:CollectCoverage=true` | MSBuild properties |

**All existing `dotnet test` invocations** (tasks.json, TFS build utility, local output generation) already use the `/p:CollectCoverage=true` MSBuild approach. **`coverlet.collector` is not used anywhere in practice.** It can be safely removed.

The silent-failure risk with `coverlet.collector`: if it is referenced but the `--collect:"XPlat Code Coverage"` flag is passed and the package is absent from a project, VSTest produces no coverage file and no error. By removing it entirely and standardizing on `coverlet.msbuild`, this ambiguity is eliminated.

---

## Requirements / Affected Scenarios

### 1. Project References

**Current state:**
```xml
<PackageReference Include="Microsoft.NET.Test.Sdk" Version="18.0.1"/>
<PackageReference Include="xunit.v3" Version="3.2.0" />
<PackageReference Include="coverlet.collector" Version="6.0.4" PrivateAssets="all"
    IncludeAssets="runtime; build; native; contentfiles; analyzers; buildtransitive" />
<PackageReference Include="coverlet.msbuild" Version="6.0.4" PrivateAssets="all"
    IncludeAssets="runtime; build; native; contentfiles; analyzers; buildtransitive" />
<PackageReference Include="xunit.runner.visualstudio" Version="3.1.5" PrivateAssets="all"
    IncludeAssets="runtime; build; native; contentfiles; analyzers; buildtransitive"/>
```

**Change:** Remove the `coverlet.collector` reference only.

**Target state:**
```xml
<PackageReference Include="Microsoft.NET.Test.Sdk" Version="18.0.1"/>
<PackageReference Include="xunit.v3" Version="3.2.0" />
<PackageReference Include="coverlet.msbuild" Version="6.0.4" PrivateAssets="all"
    IncludeAssets="runtime; build; native; contentfiles; analyzers; buildtransitive" />
<PackageReference Include="xunit.runner.visualstudio" Version="3.1.5" PrivateAssets="all"
    IncludeAssets="runtime; build; native; contentfiles; analyzers; buildtransitive"/>
```

**Why `xunit.runner.visualstudio` stays:** It keeps xunit.v3 running in VSTest mode. The Test Explorer extension and all TFS tooling depend on VSTest output (TRX files, VSTest filter syntax, `--logger trx`). Removing it would switch projects to Microsoft.Testing.Platform (MTP) mode, which has a fundamentally different protocol and would require significant rework of the extension. This is a separate decision — do not remove it as part of this task.

**Risk:** None. `coverlet.collector` was not exercised by any existing command.

---

### 2. Tasks.json — Local Test + Report Task

**Current state (`test - execute`):** Already uses `/p:CollectCoverage=true` MSBuild args. No change needed.

**Current state (`test - report`):** Uses ReportGenerator. Add `-reporttypes:Html` explicitly to ensure HTML output is always generated.

**Current state (`test - open`):** Calls `${command:coverage-gutters.previewCoverageReport}` — this is the Coverage Gutters command. This must be replaced.

**Change:** Replace the `test - open` step with a shell command that opens the ReportGenerator HTML output directly in the default browser.

```jsonc
// BEFORE
{
    "label": "test - open",
    "hide": true,
    "command": "${command:coverage-gutters.previewCoverageReport}",
}

// AFTER
{
    "label": "test - open",
    "hide": true,
    "type": "shell",
    "command": "start",
    "args": [
        "${workspaceFolder:Api.DataStore}/tests/Integration/TestResults/CoverageReport/index.html"
    ],
    "problemMatcher": []
}
```

> **Note:** Use the shell built-in `start` command directly (not `cmd /c start`) — VS Code's shell task type already runs inside cmd.exe on Windows, so `start` is available natively. Do not use `${command:...}` syntax here — that is for VS Code command IDs only, not shell commands.

Also update `test - report` to explicitly request HTML:

```jsonc
// BEFORE
"args": [
    "-reports:${workspaceFolder:Api.DataStore}/tests/Integration/TestResults/coverage.info",
    "-targetdir:${workspaceFolder:Api.DataStore}/tests/Integration/TestResults/CoverageReport"
]

// AFTER
"args": [
    "-reports:${workspaceFolder:Api.DataStore}/tests/Integration/TestResults/coverage.info",
    "-targetdir:${workspaceFolder:Api.DataStore}/tests/Integration/TestResults/CoverageReport",
    "-reporttypes:Html"
]
```

**Risk:** None. This replaces a Coverage Gutters VS Code command with a standard OS shell call.

---

### 3. TFS Build Utility (runs `dotnet test` on TFS Build Server)

**Current state:**
```csharp
.WithArguments( new string[] {
    "test", csProjFile.Name,
    "--no-build",
    "--configuration", "Release",
    "--logger", "trx;LogFileName=TestResults.trx",
    "/p:CollectCoverage=true",
    "/p:CoverletOutputFormat=cobertura",
    $"/p:Include=[KAT.{...}*]*",
    "/p:ExcludeByFile=**/LoggerMessage.g.cs",
    "/p:CoverletOutput=TestResults/coverage.cobertura.xml"
} )
```

**Change:** None. Already MSBuild-driven. Removing `coverlet.collector` from `.csproj` files has no effect on this command.

**Risk:** None.

---

### 4. Local Test / Generate Report Output Files

Used when test projects cannot run on TFS Build Servers (e.g., Test Containers). Tests are run locally, output committed, and the TFS build step consumes the committed files.

**Current state:**
```csharp
.WithArguments(new[] {
    "test", p.ProjectFile,
    "-c", "Test",
    "--logger", "trx;LogFileName=TestResults.trx",
    "/p:CollectCoverage=true",
    "/p:CoverletOutputFormat=lcov%2ccobertura",
    $"/p:Include={p.Include ?? "*"}",
    "/p:ExcludeByFile=**/LoggerMessage.g.cs",
    $"/p:CoverletOutput={projFile.DirectoryName}/TestResults/"
})
```

**Change:** None. Already MSBuild-driven.

**Risk:** None.

---

### 5. TFS Build — Publish Steps

The TFS build pipeline has two publish steps:

**Publish Test Results**
- Format: VSTest (TRX)
- Source: `**/TestResults.trx`
- **Change:** None. TRX files are still generated by `--logger trx;LogFileName=TestResults.trx`.

**Publish Code Coverage**
- Tool: Cobertura
- Source: `$(Build.SourcesDirectory)/.codeCoverage/Cobertura.xml`
- **Change:** None. Cobertura files are still generated by `coverlet.msbuild` via `/p:CoverletOutputFormat=cobertura`. File format and location are unchanged.

**Risk:** None.

---

## Summary of Changes

| Area | Change Required | Risk |
|---|---|---|
| Test project `.csproj` files | Remove `coverlet.collector` package reference | None |
| `tasks.json` — `test - open` step | Replace Coverage Gutters command with `cmd /c start index.html` | None |
| `tasks.json` — `test - report` step | Add `-reporttypes:Html` arg | None |
| TFS Build Utility (`dotnet test` args) | None | — |
| Local Output Generation (`dotnet test` args) | None | — |
| TFS Publish Test Results step | None | — |
| TFS Publish Code Coverage step | None | — |
| Coverage Gutters extension | Uninstall / remove from recommendations | — |

The total change footprint is small: one package removed from each test `.csproj`, and two lines changed in `tasks.json`.
